#+TITLE: Ticket 2: Build a Docker File
#+AUTHOR: Zach Mandeville
#+DATE: 10 July 2020

* The Ticket
  Create a simple DockerFile that has all necessary programs at startup to be able to initialize all our tables, functions, and views

We can start with the DockerFile from cncf/apisnoop, but remove any unnecessary dependencies or obfuscations.

We can say this ticket is done when one can start up postgres with

docker run -p 5432:5432 -e POSTGRES_USER="something" POSTGRES_PASSWORD="somethingelse" snoop

and the resulting db has plpython3u and pg-semver already added as extension and the snoopUtils programs available to the python functions.

the subsequent creation of all sql files will be handled in #1
* Build Simple DockerFile
  I want the minimum of fuss while making sure we can run all our python scripts.

** First Pass
   #+begin_src docker
     FROM postgres:12.0
      MAINTAINER Zach Mandeville <zz@ii.coop>
      RUN apt-get update \
        && apt-get install -y --no-install-recommends \
        postgresql-plpython3-12 \
        postgresql-12-plsh \
        postgresql-server-dev-12 \
        python3-bs4\
        python3-psycopg2\
        python3-ipdb\
        python3-requests \
        python3-yaml \
        libpq-dev \
        wget \
        make \
        gcc \
        libc6-dev \
        curl \
        jq \
        git \
        software-properties-common \
        apt-transport-https

      COPY ./db ./db
      COPY initdb /docker-entrypoint-initdb.d
      COPY ./snoopUtils.py /usr/local/lib/python3.7/dist-packages/snoopUtils.py
      HEALTHCHECK --interval=10s --timeout=5s --start-period=5s --retries=5 \
        CMD ["echo 'ready'"] || exit 1
   #+end_src
